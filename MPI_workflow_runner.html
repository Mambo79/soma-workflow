

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MPI workflow runner —beta— &mdash; soma-workflow version 2.6 documentation</title>
    
    <link rel="stylesheet" href="_static/default.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '',
        VERSION:     '2.6.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <link rel="shortcut icon" href="_static/icon_small.png"/>
    <link rel="top" title="soma-workflow version 2.6 documentation" href="index.html" />
    <link rel="next" title="Tips, Good Practices and Errors" href="errors_troubleshooting.html" />
    <link rel="prev" title="Examples" href="examples.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="errors_troubleshooting.html" title="Tips, Good Practices and Errors"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Examples"
             accesskey="P">previous</a> |</li>
        <li><a href="index.html">soma-workflow version 2.6 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mpi-workflow-runner-beta">
<span id="mpi-workflow-runner"></span><h1>MPI workflow runner &#8212;<strong>beta</strong>&#8212;<a class="headerlink" href="#mpi-workflow-runner-beta" title="Permalink to this headline">¶</a></h1>
<dl class="docutils">
<dt>The MPI workflow runner is a second way of executing workflows using a cluster:</dt>
<dd><ul class="first last simple">
<li>high throughput mode (using DRMAA for example): 1 job = 1 cluster job</li>
<li>low throughput mode with the MPI workflow runner: 1 workflow = 1 cluster job</li>
</ul>
</dd>
</dl>
<a class="reference internal image-reference" href="_images/sw_high_throughput.png"><img alt="_images/sw_high_throughput.png" src="_images/sw_high_throughput.png" style="width: 438.6px; height: 309.0px;" /></a>
<a class="reference internal image-reference" href="_images/sw_low_throughput.png"><img alt="_images/sw_low_throughput.png" src="_images/sw_low_throughput.png" style="width: 462.6px; height: 304.2px;" /></a>
<dl class="docutils">
<dt>This mode makes it possible:</dt>
<dd><ul class="first last simple">
<li>to run workflows on clusters with limited number of job per user.</li>
<li>to run workflows on clusters where it is not possible to run a server process.</li>
<li>to run workflows if you only have a simple MPI installation.</li>
<li>to remove the time interval between jobs execution which is due to the submission of each job to the cluster management system.</li>
</ul>
</dd>
</dl>
<p>This mode is for advenced users who know how to use a cluster. In this mode the workflow control (submission, stop and resart) via the python API is disabled. The DRMS commands such as <em>qsub</em> and <em>qdel</em> for PBS for example, must be used instead. However, the monitoring tools (GUI and Python API) remains the same.</p>
<div class="section" id="requirements">
<h2>Requirements:<a class="headerlink" href="#requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Python <em>version 2.5 or more</em></li>
<li><a class="reference external" href="https://code.google.com/p/mpi4py">MPI4py</a></li>
</ul>
</div>
<div class="section" id="installation">
<h2>Installation:<a class="headerlink" href="#installation" title="Permalink to this headline">¶</a></h2>
<p>This mode use pure Python code, you do not need to compile anything: c.f. <a class="reference external" href="http://brainvisa.info/soma-workflow">Soma-workflow main page</a> for installation.</p>
</div>
<div class="section" id="configuration">
<h2>Configuration:<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Required items:</p>
<blockquote>
<div><ul class="simple">
<li>DATABASE_FILE</li>
<li>TRANSFERED_FILES_DIR</li>
<li>SCHEDULER_TYPE</li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>SCHEDULER_TYPE must be set to &#8220;mpi&#8221;</strong></p>
</div>
<p>Example:</p>
<div class="highlight-python"><pre>[Titan_MPI]

DATABASE_FILE        = path_mpi_runner_config/soma_workflow.db
TRANSFERED_FILES_DIR = path_mpi_runner_config/transfered_files
SCHEDULER_TYPE       = mpi

# optional logging
SERVER_LOG_FILE   = path/logs/log_server
SERVER_LOG_FORMAT = %(asctime)s =&gt; line %(lineno)s: %(message)s
SERVER_LOG_LEVEL  = ERROR
ENGINE_LOG_DIR    = path/logs/
ENGINE_LOG_FORMAT = %(asctime)s =&gt; line %(lineno)s: %(message)s
ENGINE_LOG_LEVEL  = ERROR</pre>
</div>
<p>Optionally, to monitor the workflow execution from a remote machine, the following lines can be used to configure soma-workflow on that machine:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">[</span><span class="n">Titan_MPI</span><span class="p">]</span>
<span class="c"># remote access information</span>
<span class="n">CLUSTER_ADDRESS</span>     <span class="o">=</span> <span class="n">titan</span><span class="o">.</span><span class="n">mylab</span><span class="o">.</span><span class="n">fr</span>
<span class="n">SUBMITTING_MACHINES</span> <span class="o">=</span> <span class="n">titan0</span>

<span class="c"># optional</span>
<span class="n">LOGIN</span> <span class="o">=</span> <span class="n">my_login_on_titan</span>
</pre></div>
</div>
</div>
<div class="section" id="mpi-workflow-runner-options">
<h2>MPI_workflow_runner options:<a class="headerlink" href="#mpi-workflow-runner-options" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><pre>$ python -m soma_workflow.MPI_workflow_runner --help
Usage: MPI_workflow_runner.py [options]

Options:
  -h, --help            show this help message and exit
  --workflow=WORKFLOW_FILE
                        The workflow to run.
  -r WF_ID_TO_RESTART, --restart=WF_ID_TO_RESTART
                        The workflow id to restart
  --nb_attempt_per_job=NB_ATTEMPT_PER_JOB
                        A job can be restarted several time if it fails. This
                        option specify the number of attempt per job. By
                        default, the jobs are not restarted.</pre>
</div>
</div>
<div class="section" id="example-using-pbs">
<h2>Example using PBS:<a class="headerlink" href="#example-using-pbs" title="Permalink to this headline">¶</a></h2>
<p>Create a submission script for PBS (example <em>run_workflow.sh</em>):</p>
<div class="highlight-python"><pre>#!/bin/bash
#PBS -N my_workflow
#PBS -j oe
#PBS -l walltime=10:00:00
#PBS -l nodes=3:ppn=8
#PBS -q long

time mpirun python -m soma_workflow.MPI_workflow_runner Titan_MPI --workflow $HOME/my_workflow_file</pre>
</div>
<p>In the example, the workflow will run on 8 cores of 3 nodes (that is 8*3 cpus). It will be submitted to the &#8220;long&#8221; queue, and will last at most 10 hours.</p>
<p>Use the following command to submit the script to the cluster, and thus start the workflow execution:</p>
<div class="highlight-python"><pre>$ qsub run_workflow.sh</pre>
</div>
<p>You will get an cluster id for the MPI job you have submitted (112108 for example).
Use the following command line to kill the MPI job and thus stop workflow execution:</p>
<div class="highlight-python"><pre>$ qdel 112108</pre>
</div>
<p>Each workflow has an id in Soma-workflow. This id is displayed in the GUI or can be recovered using the Python API (example 520).
Use the following submission script to restart the workflow:</p>
<div class="highlight-python"><pre>#!/bin/bash
#PBS -N my_workflow
#PBS -j oe
#PBS -l walltime=10:00:00
#PBS -l nodes=3:ppn=8
#PBS -q long

time mpirun python -m soma_workflow.MPI_workflow_runner Titan_MPI --restart 520</pre>
</div>
<p>As before, use &#8220;qsub&#8221; to submit the workflow and possibly &#8220;qdel&#8221; to stop it.</p>
</div>
<div class="section" id="current-limitations">
<h2>Current limitations:<a class="headerlink" href="#current-limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The workflow must contain jobs using only one CPU</li>
<li>It is safer to run only one MPI workflow runner at the same time</li>
<li>As in the following example, some workflows might result of a waste of CPU time.</li>
</ul>
<a class="reference internal image-reference" href="_images/sw_low_throughput_wasted_cpus.png"><img alt="_images/sw_low_throughput_wasted_cpus.png" src="_images/sw_low_throughput_wasted_cpus.png" style="width: 814.8px; height: 304.2px;" /></a>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="index.html">
              <img class="logo" src="_static/logo_white_small.png" alt="Logo"/>
            </a></p>
  <h3><a href="index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MPI workflow runner &#8212;<strong>beta</strong>&#8212;</a><ul>
<li><a class="reference internal" href="#requirements">Requirements:</a></li>
<li><a class="reference internal" href="#installation">Installation:</a></li>
<li><a class="reference internal" href="#configuration">Configuration:</a></li>
<li><a class="reference internal" href="#mpi-workflow-runner-options">MPI_workflow_runner options:</a></li>
<li><a class="reference internal" href="#example-using-pbs">Example using PBS:</a></li>
<li><a class="reference internal" href="#current-limitations">Current limitations:</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="examples.html"
                        title="previous chapter">Examples</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="errors_troubleshooting.html"
                        title="next chapter">Tips, Good Practices and Errors</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="_sources/MPI_workflow_runner.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="errors_troubleshooting.html" title="Tips, Good Practices and Errors"
             >next</a> |</li>
        <li class="right" >
          <a href="examples.html" title="Examples"
             >previous</a> |</li>
        <li><a href="index.html">soma-workflow version 2.6 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011 CEA, Neurospin, France, CATI, France.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>