======================
Soma-workflow concepts
======================


Job, Worklfows and File Transfers
=================================

**Job**

  A job is mainly defined by a program command line. It doesn't necessarly need 
  several CPU to be executed.

  A parallel job is a job made to run on several CPU. The program uses parallel
  code such as MPI, OpenMP.. 

**Workflow**

  A workflow organizes the execution of a set of jobs defining execution 
  dependencies between jobs.

  A dependency from a job A to a job B means that the job A won't start before 
  the job B is done. 

  .. figure:: images/workflow_example.*
    :scale: 50 

    Workflow example. The jobs are reprensented by blue boxes and the 
    dependencies by black arrows.

  Once the workflow is created (see :ref:`workflow-creation-api`), and submitted 
  to a computing resource using the API or the GUI, soma-workflow handles the 
  execution of the jobs. Each job starts as soon as possible considering its dependencies.

**File transfers**
  
  The file transfer objects are only required when the user file system is not 
  shared with the computing resource.

  A file transfer object is a mapping between a file path of the user file system
  and file path of the computing ressource file system.

  Soma-workflow handles transfers of the files or directory to and from the 
  computing resource file system. The file transfer objects are associated to 
  jobs (as input or output) in workflows. That way the jobs won't be executed 
  before the files were transfered on the computing resource.

.. _shared-resource-path-concept:

**Shared resource path**




DRMS, Client, Workflow Engine and Database Server
=================================================

.. image:: images/architecture_overview.* 
  :scale: 50 
  
..
  The soma-workflow architecture allows the client to access remote computing 
  resource and to disconnect at any time. The WorkflowEngine process, which runs 
  on the computing resource side, is in charge of submitting the workflow's jobs
  to the DRMS at the right time. 

Status
======


Warning status
--------------

The workflow engine process in charge of the job or workflow was killed or failed
on the computing resource side. In that case a simple solution is to restart the
workflow. The job which ended with success won't be restarted. 


However, the warning status doesn't mean that the jobs failed. In case of very 
long job which you don't want to restart, you can check yourself
the status of the job(s) on the DRMS. If some jobs are running: you have to wait 
for the job to finished. Afterward, update the status of each job in 
soma-workflow and restart the jobs.


Job status
----------

Here is the list of the job status.

  |no_status| **not_submitted**
    The job was not submitted yet to soma-workflow.

  |undeter| **undetermined**
    Transitive status. The job status is changing and be updated soon

  |pending| **submission_pending**
    Due to a limitation of the number of job in the queue (see ??), the job is 
    waiting to be submitted to the DRMS.
  
  |queued| **queued_active**
    The job was submitted to the DRMS and is currently waiting in the queue.
  
  |running| **running**
    The job is running on the computing resource.

  |success| |failed| **done**
    The job finished normally. However it doesn't mean that it ended with 
    success (see :ref:`job-exit-status`)

  |failed| **failed**
    The job exited abnormally before finishing.

  |warning| **warning**
    The worklfow engine process in charge of the monitoring of the job status
    was killed or failed. The job or the workflow containing the job has to be 
    restarted.

  |kd_pending| **delete_pending**    
    Transitive status. The job will be deleted soon.

  |kd_pending| **kill_pending**       
    Transitive status. The job will be killed soon.
    
..
  system_on_hold
  user_on_hold
  user_system_on_hold
  system_suspended
  user_suspended
  user_system_suspended


.. _job-exit-status:

Job exit status
--------------- 

  **finished_regularly**
    The job finished regularly. The exit value is displayed on the GUI and is available from the python API. If the value is different than 0 soma-workflow considers that the job failed.

  **finished_signal**
    The job finished due to a signal. The signal is displayed on the GUI and is available from the python API (depending on DRMAA implementation).

  **killed_by_user**
     The job was killed by the user.

  **aborted**
    The job never ran.

  **exit_status_undetermined**
    The exit status can't be determined.

  **finished_unclear_condition**
    The job finished with unclear conditions.




Workflow status
---------------

  **worklflow_not_started**
    The workflow was not submitted to soma-workflow.
  
  **workflow_in_progress**
    The workflow was submitted to soma-workflow.

  **workflow_done**
    The workflow is done.

  **delete_pending**
    Transitive status. The workflow will be deleted soon.

  **warning**
    The worklfow engine process in charge of the workflow execution was killed 
    on the computing resource side. The workflow has to be restarted (the jobs 
    which ended with success won't be restarted). 














.. |no_status| image:: ../../python/soma/workflow/gui/icon/no_status.png
               :height: 100 px
               :width: 100 px
               :scale: 30 

.. |undeter|   image:: ../../python/soma/workflow/gui/icon/undetermined.png
               :height: 100 px
               :width: 100 px
               :scale: 30 

.. |queued|    image:: ../../python/soma/workflow/gui/icon/queued.png
               :height: 100 px
               :width: 100 px
               :scale: 30 

.. |running|   image:: ../../python/soma/workflow/gui/icon/running.png
               :height: 100 px
               :width: 100 px
               :scale: 30 

.. |success|   image:: ../../python/soma/workflow/gui/icon/success.png
               :height: 100 px
               :width: 100 px
               :scale: 30 

.. |kd_pending| image:: ../../python/soma/workflow/gui/icon/kill_delete_pending.png
                    :height: 100 px
                    :width: 100 px
                    :scale: 30 

.. |warning| image:: ../../python/soma/workflow/gui/icon/warning.png
            :height: 100 px
            :width: 100 px
            :scale: 30 

.. |failed| image:: ../../python/soma/workflow/gui/icon/failed.png
            :height: 100 px
            :width: 100 px
            :scale: 30 

.. |pending| image:: ../../python/soma/workflow/gui/icon/pending.png
            :height: 100 px
            :width: 100 px
            :scale: 30 




..
  ===========================  =================================================
  Exit status                  Meaning
  ===========================  =================================================
  finished_regularly           The job finished regularly. The exit value is 
                               displayed on the GUI and is available from the 
                               python API. If the value is different than 0 
                               soma-workflow consider that the job failed.
  finished_signal              The job finished due to a signal. The signal is 
                               displayed on the GUI and is available from the 
                               python API (depending on DRMAA implementation).
  killed_by_user               The job was killed by the user.
  aborted                      The job never ran.
  exit_status_undetermined     The exit status can't be determined.
  finished_unclear_condition   The job finished with unclear conditions.
  ===========================  =================================================


..
                      ======================  ==================================
                      Workflow status         Meaning
                      ======================  ==================================
                      worklflow_not_started   The workflow was not 
                                              submitted to soma-workflow.
                      workflow_in_progress    The workflow was submitted 
                                              to soma-workflow.
                      workflow_done           The workflow is done.
                      delete_pending          Transitive status. The workflow 
                                              will be deleted soon.
                      warning                 The worklfow engine process 
                                              in charge of the workflow
                                              execution was killed on the 
                                              computing resource side.
                                              The workflow has to be restarted 
                                              (the jobs which ended 
                                              with success won't be restarted). 
                      ======================  ==================================


..
  ===================== ================== =======================================
  Icon                  Status             Meaning
  ===================== ================== =======================================
  |no_status|           not_submitted      The job was not submitted yet to 
                                           soma-workflow.
  |undeter|             undetermined       Transitive status. The job status 
                                           is changing and be updated soon.
  |pending|             submission_pending Due to a limitation of the number of job 
                                           in the queue (see ??), the job is 
                                           waiting to be submitted to the DRMS. 
  |queued|              queued_active      The job was submitted to the DRMS and 
                                           is currently waiting in the queue.
  |running|             running            The job is running on the computing 
                                           resource.
  |success| or |failed| done               The job finished normally. However it 
                                           doesn't mean that it ended with success
                                           (see :ref:`job-exit-status`)
  |failed|              failed             The job exited abnormally before
                                           finishing.
  |warning|             warning            The worklfow engine process in charge 
                                           of the monitoring of the job status 
                                           was killed or failed. The job or the 
                                           workflow containing the job has to be 
                                           restarted.
  |kd_pending|          delete_pending     Transitive status. The job will be  
                                           deleted soon.
  |kd_pending|          kill_pending       Transitive status. The job will be 
                                           killed soon.
  ===================== ================== =======================================