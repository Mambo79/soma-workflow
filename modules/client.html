

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>client &mdash; soma-workflow developement version documentation</title>
    
    <link rel="stylesheet" href="../static/default.css" type="text/css" />
    <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.5.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../static/jquery.js"></script>
    <script type="text/javascript" src="../static/underscore.js"></script>
    <script type="text/javascript" src="../static/doctools.js"></script>
    <link rel="shortcut icon" href="../static/icon_small.png"/>
    <link rel="top" title="soma-workflow developement version documentation" href="../index.html" />
    <link rel="up" title="Module code" href="index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li><a href="../index.html">soma-workflow developement version documentation</a> &raquo;</li>
          <li><a href="index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for client</h1><div class="highlight"><pre>
<span class="c"># -*- coding: utf-8 -*-</span>

<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">@author: Soizic Laguitton</span>

<span class="sd">@organization: I2BM, Neurospin, Gif-sur-Yvette, France</span>
<span class="sd">@organization: CATI, France</span>
<span class="sd">@organization: U{IFR 49&lt;http://www.ifr49.org&gt;}</span>

<span class="sd">@license: U{CeCILL version 2&lt;http://www.cecill.info/licences/Licence_CeCILL_V2-en.html&gt;}</span>
<span class="sd">&#39;&#39;&#39;</span>


<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># Imports</span>
<span class="c">#-------------------------------------------------------------------------------</span>

<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">stat</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">types</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">posixpath</span>

<span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
  <span class="kn">import</span> <span class="nn">json</span>
<span class="c">#import cProfile</span>
<span class="c">#import traceback</span>

<span class="kn">import</span> <span class="nn">soma.workflow.connection</span> <span class="kn">as</span> <span class="nn">connection</span>
<span class="kn">from</span> <span class="nn">soma.workflow.transfer</span> <span class="kn">import</span> <span class="n">PortableRemoteTransfer</span><span class="p">,</span> <span class="n">TransferSCP</span><span class="p">,</span> <span class="n">TransferRsync</span><span class="p">,</span> <span class="n">TransferMonitoring</span><span class="p">,</span> <span class="n">TransferLocal</span>
<span class="kn">import</span> <span class="nn">soma.workflow.constants</span> <span class="kn">as</span> <span class="nn">constants</span>
<span class="kn">import</span> <span class="nn">soma.workflow.configuration</span> <span class="kn">as</span> <span class="nn">configuration</span>
<span class="kn">from</span> <span class="nn">soma.workflow.errors</span> <span class="kn">import</span> <span class="n">TransferError</span><span class="p">,</span> <span class="n">SerializationError</span><span class="p">,</span> <span class="n">SomaWorkflowError</span>


<span class="c">#-------------------------------------------------------------------------------</span>
<span class="c"># Classes and functions</span>
<span class="c">#-------------------------------------------------------------------------------</span>

<span class="c"># imports required by the users of soma-workflow API (do not remove):</span>
<span class="kn">from</span> <span class="nn">soma.workflow.client_types</span> <span class="kn">import</span> <span class="n">Job</span>
<span class="kn">from</span> <span class="nn">soma.workflow.client_types</span> <span class="kn">import</span> <span class="n">Workflow</span>
<span class="kn">from</span> <span class="nn">soma.workflow.client_types</span> <span class="kn">import</span> <span class="n">Group</span>
<span class="kn">from</span> <span class="nn">soma.workflow.client_types</span> <span class="kn">import</span> <span class="n">FileTransfer</span>
<span class="kn">from</span> <span class="nn">soma.workflow.client_types</span> <span class="kn">import</span> <span class="n">SharedResourcePath</span>


<div class="viewcode-block" id="WorkflowController"><a class="viewcode-back" href="../client_API.html#client.WorkflowController">[docs]</a><span class="k">class</span> <span class="nc">WorkflowController</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Submission, control and monitoring of Job, FileTransfer and Workflow</span>
<span class="sd">  objects.</span>
<span class="sd">  &#39;&#39;&#39;</span>

  <span class="n">_connection</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">_engine_proxy</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">_transfer</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">_transfer_stdouterr</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">config</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">engine_config_proxy</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">_resource_id</span> <span class="o">=</span> <span class="bp">None</span>

  <span class="n">scheduler_config</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="WorkflowController.__init__"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.__init__">[docs]</a>  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
               <span class="n">resource_id</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">login</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">password</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">config</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
               <span class="n">rsa_key_pass</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets up the connection to the computing resource.</span>
<span class="sd">    Looks for a soma-workflow configuration file (if not specified in the</span>
<span class="sd">    *config* argument).</span>

<span class="sd">    * resource_id *string*</span>
<span class="sd">        Identifier of the computing resource to connect to.</span>
<span class="sd">        If None, the number of cpu of the current machine is detected and the basic scheduler is lauched.</span>

<span class="sd">    * login *string*</span>
<span class="sd">        Required if the computing resource is remote.</span>

<span class="sd">    * password *string*</span>
<span class="sd">        Required if the computing resource is remote and not RSA key where</span>
<span class="sd">        configured to log on the remote machine with ssh.</span>

<span class="sd">    * config *configuration.Configuration*</span>
<span class="sd">        Optional configuration.</span>

<span class="sd">    * rsa_key_pass *string*</span>
<span class="sd">        Required if the RSA key is protected with a password.</span>

<span class="sd">    .. note::</span>
<span class="sd">      The login and password are only required for a remote computing resource.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="n">config</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">Configuration</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">resource_id</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_config</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="n">mode</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_mode</span><span class="p">()</span>
    <span class="c">#print  mode + &quot; mode&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_resource_id</span> <span class="o">=</span> <span class="n">resource_id</span>
    
    

    <span class="c"># LOCAL MODE</span>
    <span class="k">if</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LOCAL_MODE</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">LocalConnection</span><span class="p">(</span><span class="n">resource_id</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_workflow_engine</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_configuration</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span> <span class="o">=</span> <span class="n">TransferLocal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_stdouterr</span> <span class="o">=</span> <span class="n">TransferLocal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>
      

    <span class="c"># REMOTE MODE</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">REMOTE_MODE</span><span class="p">:</span>
      <span class="n">submitting_machines</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_submitting_machines</span><span class="p">()</span>
      <span class="n">sub_machine</span> <span class="o">=</span> <span class="n">submitting_machines</span><span class="p">[</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span>
                                                    <span class="nb">len</span><span class="p">(</span><span class="n">submitting_machines</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
      <span class="n">cluster_address</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">get_cluster_address</span><span class="p">()</span>
      <span class="c">#print &#39;cluster address: &#39; + cluster_address + &#39; submission machine: &#39; + sub_machine</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="n">connection</span><span class="o">.</span><span class="n">RemoteConnection</span><span class="p">(</span><span class="n">login</span><span class="p">,</span>
                                                    <span class="n">password</span><span class="p">,</span>
                                                    <span class="n">cluster_address</span><span class="p">,</span>
                                                    <span class="n">sub_machine</span><span class="p">,</span>
                                                    <span class="n">resource_id</span><span class="p">,</span>
                                                    <span class="s">&quot;&quot;</span><span class="p">,</span>
                                                    <span class="n">rsa_key_pass</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_workflow_engine</span><span class="p">()</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">get_configuration</span><span class="p">()</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">password</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rsa_key_pass</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span> <span class="o">=</span> <span class="n">TransferSCP</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">,</span>
                                    <span class="n">username</span><span class="o">=</span><span class="n">login</span><span class="p">,</span>
                                    <span class="n">hostname</span><span class="o">=</span><span class="n">sub_machine</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span> <span class="o">=</span> <span class="n">PortableRemoteTransfer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_stdouterr</span> <span class="o">=</span> <span class="n">PortableRemoteTransfer</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>

    <span class="c"># LIGHT MODE</span>
    <span class="k">elif</span> <span class="n">mode</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LIGHT_MODE</span><span class="p">:</span>
      <span class="n">local_scdl_cfg_path</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LocalSchedulerCfg</span><span class="o">.</span><span class="n">search_config_path</span><span class="p">()</span>
      <span class="k">if</span> <span class="n">local_scdl_cfg_path</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
        <span class="n">cpu_count</span> <span class="o">=</span> <span class="n">Helper</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LocalSchedulerCfg</span><span class="p">(</span><span class="n">proc_nb</span><span class="o">=</span><span class="n">cpu_count</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_config</span> <span class="o">=</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LocalSchedulerCfg</span><span class="o">.</span><span class="n">load_from_file</span><span class="p">(</span><span class="n">local_scdl_cfg_path</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span> <span class="o">=</span> <span class="n">_embedded_engine_and_server</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="p">,</span> 
                                                       <span class="bp">self</span><span class="o">.</span><span class="n">scheduler_config</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">config</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span> <span class="o">=</span> <span class="n">TransferLocal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_stdouterr</span> <span class="o">=</span> <span class="n">TransferLocal</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>


    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_monitoring</span> <span class="o">=</span> <span class="n">TransferMonitoring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="p">)</span>


</div>
  <span class="k">def</span> <span class="nf">disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Simulates a disconnection for TEST PURPOSE ONLY.</span>
<span class="sd">    !!! The current instance will not be usable anymore after this call !!!!</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_connection</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>



  <span class="c">########## SUBMISSION / REGISTRATION ####################################</span>

<div class="viewcode-block" id="WorkflowController.submit_workflow"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.submit_workflow">[docs]</a>  <span class="k">def</span> <span class="nf">submit_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                      <span class="n">workflow</span><span class="p">,</span>
                      <span class="n">expiration_date</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">name</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                      <span class="n">queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Submits a workflow and returns a workflow identifier.</span>

<span class="sd">    * workflow *client.Workflow*</span>
<span class="sd">        Workflow description.</span>

<span class="sd">    * expiration_date *datetime.datetime*</span>
<span class="sd">        After this date the workflow will be deleted.</span>

<span class="sd">    * name *string*</span>
<span class="sd">        Optional workflow name.</span>

<span class="sd">    * queue *string*</span>
<span class="sd">        Optional name of the queue where to submit jobs. If it is not specified</span>
<span class="sd">        the jobs will be submitted to the default queue.</span>

<span class="sd">    * returns: *int*</span>
<span class="sd">        Workflow identifier.</span>

<span class="sd">    Raises *WorkflowError* or *JobError* if the workflow is not correct.</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">MPI_SCHEDULER</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SomaWorkflowError</span><span class="p">(</span><span class="s">&quot;The MPI scheduler is configured for this resource. &quot;</span>
                              <span class="s">&quot;Use soma.workflow.MPI_workflow_runner to submit a workflow using the MPI scheduler.&quot;</span><span class="p">)</span> 


    <span class="c">#cProfile.runctx(&quot;wf_id = self._engine_proxy.submit_workflow(workflow, expiration_date, name, queue)&quot;, globals(), locals(), &quot;/home/soizic/profile/profile_submit_workflow&quot;)</span>

    <span class="n">wf_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">submit_workflow</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span>
                                               <span class="n">expiration_date</span><span class="p">,</span>
                                               <span class="n">name</span><span class="p">,</span>
                                               <span class="n">queue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">wf_id</span>

</div>
<div class="viewcode-block" id="WorkflowController.submit_job"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.submit_job">[docs]</a>  <span class="k">def</span> <span class="nf">submit_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **deprecated since version 2.4:** Use submit_workflow instead.</span>

<span class="sd">    Submits a job which is not part of a workflow.</span>
<span class="sd">    Returns a job identifier.</span>

<span class="sd">    If the job used transfered files the list of involved file transfer **must</span>
<span class="sd">    be** specified setting the arguments: *referenced_input_files* and</span>
<span class="sd">    *referenced_output_files*.</span>

<span class="sd">    Each path must be reachable from the computing resource.</span>

<span class="sd">    * job *client.Job*</span>

<span class="sd">    * queue *string*</span>
<span class="sd">        Name of the queue where to submit the jobs. If it is not</span>
<span class="sd">        specified the job will be submitted to the default queue.</span>

<span class="sd">    * returns: int</span>
<span class="sd">      Job identifier.</span>

<span class="sd">    Raises *JobError* if the job is not correct.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">print</span> <span class="s">&quot;The method submit_job is deprecated since version 2.4. Use submit_workflow instead.&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">MPI_SCHEDULER</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SomaWorkflowError</span><span class="p">(</span><span class="s">&quot;The MPI scheduler is configured for this resource. &quot;</span>
                              <span class="s">&quot;Use soma.workflow.MPI_workflow_runner to submit a workflow using the MPI scheduler.&quot;</span><span class="p">)</span> 

    <span class="n">job_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">submit_job</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">job_id</span>

</div>
<div class="viewcode-block" id="WorkflowController.register_transfer"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.register_transfer">[docs]</a>  <span class="k">def</span> <span class="nf">register_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_transfer</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Registers a file transfer which is not part of a workflow and returns a</span>
<span class="sd">    file transfer identifier.</span>

<span class="sd">    * file_transfer *client.FileTransfer*</span>

<span class="sd">    * returns *EngineTransfer*</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">engine_transfer</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">register_transfer</span><span class="p">(</span><span class="n">file_transfer</span><span class="p">)</span>


    <span class="k">return</span> <span class="n">engine_transfer</span>

  <span class="c">########## WORKFLOWS, JOBS and FILE TRANSFERS RETRIEVAL ###################</span>
</div>
<div class="viewcode-block" id="WorkflowController.workflow"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.workflow">[docs]</a>  <span class="k">def</span> <span class="nf">workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    * workflow_id *workflow_identifier*</span>

<span class="sd">    * returns: *Workflow*</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">workflow</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WorkflowController.workflows"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.workflows">[docs]</a>  <span class="k">def</span> <span class="nf">workflows</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Lists the identifiers and general information about all the workflows</span>
<span class="sd">    submitted by the user, or about the workflows specified in the</span>
<span class="sd">    *workflow_ids* argument.</span>

<span class="sd">    * workflow_ids *sequence of workflow identifiers*</span>

<span class="sd">    * returns: *dictionary: workflow identifier -&gt; tuple(date, string)*</span>
<span class="sd">        workflow_id -&gt; (workflow_name, expiration_date)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">workflows</span><span class="p">(</span><span class="n">workflow_ids</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.jobs"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.jobs">[docs]</a>  <span class="k">def</span> <span class="nf">jobs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Lists the identifiers and general information about all the jobs submitted</span>
<span class="sd">    by the user and which are not part of a workflow, or about the jobs</span>
<span class="sd">    specified in the *job_ids* argument.</span>

<span class="sd">    * job_ids *sequence of job identifiers*</span>

<span class="sd">    * returns: *dictionary: job identifiers -&gt; tuple(string, string, date)*</span>
<span class="sd">        job_id -&gt; (name, command, submission date)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">jobs</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.transfers"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.transfers">[docs]</a>  <span class="k">def</span> <span class="nf">transfers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_ids</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Lists the identifiers and information about all the user&#39;s file transfers</span>
<span class="sd">    which are not part of a workflow or about the file transfers specified in</span>
<span class="sd">    the *transfer_ids* argument.</span>

<span class="sd">    * transfer_ids *sequence of FileTransfer identifiers*</span>

<span class="sd">    * returns: *dictionary: string -&gt; tuple(string, date, None or sequence of string)*</span>
<span class="sd">        transfer_id -&gt; (</span>
<span class="sd">                        * client_path: client file or directory path</span>
<span class="sd">                        * expiration_date: after this date the file copied</span>
<span class="sd">                          on the computing resource and all the transfer</span>
<span class="sd">                          information will be deleted, unless an existing</span>
<span class="sd">                          job has declared this file as output or input.</span>
<span class="sd">                        * client_paths: sequence of file or directory path or None)</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">transfers</span><span class="p">(</span><span class="n">transfer_ids</span><span class="p">)</span>

  <span class="c">########## WORKFLOW MONITORING #########################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.workflow_status"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.workflow_status">[docs]</a>  <span class="k">def</span> <span class="nf">workflow_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * returns: *string or None*</span>
<span class="sd">        Status of the workflow: see :ref:`workflow-status` or the</span>
<span class="sd">        constants.WORKFLOW_STATUS list.</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">workflow_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.workflow_elements_status"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.workflow_elements_status">[docs]</a>  <span class="k">def</span> <span class="nf">workflow_elements_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Gets back the status of all the workflow elements at once, minimizing the</span>
<span class="sd">    communication with the server and request to the database.</span>
<span class="sd">    TO DO =&gt; make it more user friendly.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * returns: tuple (sequence of tuple (job_id, status, queue, exit_info, </span>
<span class="sd">      (submission_date, execution_date, ending_date)), sequence of tuple</span>
<span class="sd">      (transfer_id, (status, progression_info)), workflow_status, workflow_queue)</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">wf_status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">workflow_elements_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
    <span class="c"># special processing for transfer status:</span>
    <span class="n">new_transfer_status</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">engine_path</span><span class="p">,</span> <span class="n">client_path</span><span class="p">,</span> <span class="n">client_paths</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">transfer_type</span> <span class="ow">in</span> <span class="n">wf_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="n">progression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_progression</span><span class="p">(</span><span class="n">status</span><span class="p">,</span>
                                               <span class="n">transfer_type</span><span class="p">,</span>
                                               <span class="n">client_path</span><span class="p">,</span>
                                               <span class="n">client_paths</span><span class="p">,</span>
                                               <span class="n">engine_path</span><span class="p">)</span>

      <span class="n">new_transfer_status</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">engine_path</span><span class="p">,</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">progression</span><span class="p">)))</span>

    <span class="n">new_wf_status</span> <span class="o">=</span> <span class="p">(</span><span class="n">wf_status</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">new_transfer_status</span><span class="p">,</span> <span class="n">wf_status</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">wf_status</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">new_wf_status</span>


  <span class="c">########## JOB MONITORING #############################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.job_status"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.job_status">[docs]</a>  <span class="k">def</span> <span class="nf">job_status</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    * job_id *job identifier*</span>

<span class="sd">    * returns: *string*</span>
<span class="sd">        Status of the job: see :ref:`job-status` or the list</span>
<span class="sd">        constants.JOB_STATUS.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">job_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.job_termination_status"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.job_termination_status">[docs]</a>  <span class="k">def</span> <span class="nf">job_termination_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Information related to the end of the job.</span>

<span class="sd">    * job_id *job identifier*</span>

<span class="sd">    * returns: *tuple(string, int or None, string or None, string) or None*</span>
<span class="sd">        * exit status: status of the terminated job: see</span>
<span class="sd">          :ref:`job-exit-status` or the constants.JOB_EXIT_STATUS list.</span>
<span class="sd">        * exit value: operating system exit code of the job if the job</span>
<span class="sd">          terminated normally.</span>
<span class="sd">        * terminating signal: representation of the signal that caused the</span>
<span class="sd">          termination of the job if the job terminated due to the receipt of</span>
<span class="sd">          a signal.</span>
<span class="sd">        * resource usage: resource usage information provided as an array of</span>
<span class="sd">          strings where each string complies with the format &lt;name&gt;=&lt;value&gt;.</span>
<span class="sd">          The information provided depends on the DRMS and DRMAA implementation.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">job_termination_status</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.retrieve_job_stdouterr"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.retrieve_job_stdouterr">[docs]</a>  <span class="k">def</span> <span class="nf">retrieve_job_stdouterr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                             <span class="n">job_id</span><span class="p">,</span>
                             <span class="n">stdout_file_path</span><span class="p">,</span>
                             <span class="n">stderr_file_path</span> <span class="o">=</span> <span class="bp">None</span><span class="p">,</span>
                             <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">512</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Copies the job standard output and error to specified file.</span>

<span class="sd">    * job_id *job identifier*</span>

<span class="sd">    * stdout_file_path *string*</span>
<span class="sd">        Path of the file where to copy the standard output.</span>

<span class="sd">    * stderr_file_path *string*</span>
<span class="sd">        Path of the file where to copy the standard error.</span>

<span class="sd">    * buffer_size *int*</span>
<span class="sd">        The file is transfered piece by piece of size buffer_size.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">stdout_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">stdout_file_path</span><span class="p">)</span>
    <span class="n">stderr_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">stderr_file_path</span><span class="p">)</span>
    <span class="p">(</span><span class="n">engine_stdout_file</span><span class="p">,</span> <span class="n">engine_stderr_file</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">stdouterr_file_path</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_stdouterr</span><span class="o">.</span><span class="n">transfer_from_remote</span><span class="p">(</span><span class="n">engine_stdout_file</span><span class="p">,</span>
                                                  <span class="n">stdout_file_path</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_stdouterr</span><span class="o">.</span><span class="n">transfer_from_remote</span><span class="p">(</span><span class="n">engine_stderr_file</span><span class="p">,</span>
                                                  <span class="n">stderr_file_path</span><span class="p">)</span>


  <span class="c">########## FILE TRANSFER MONITORING ###################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.transfer_status"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.transfer_status">[docs]</a>  <span class="k">def</span> <span class="nf">transfer_status</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    File transfer status and information related to the transfer progress.</span>

<span class="sd">    * transfer_id *transfer identifier*</span>

<span class="sd">    * returns: *tuple(transfer_status or None, tuple or None)*</span>
<span class="sd">        * Status of the file transfer : see :ref:`file-transfer-status` or the</span>
<span class="sd">          constants.FILE_TRANSFER_STATUS list.</span>
<span class="sd">        * None if the transfer status in not</span>
<span class="sd">          constants.TRANSFERING_FROM_CLIENT_TO_CR or</span>
<span class="sd">          constants.TRANSFERING_FROM_CR_TO_CLIENT.</span>
<span class="sd">          tuple (file size, size already transfered) if it is a file transfer.</span>
<span class="sd">          tuple (cumulated size, sequence of tuple (relative_path, file_size, size already transfered) if it is a directory transfer.</span>

<span class="sd">    Raises *UnknownObjectError* if the transfer_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
    <span class="n">client_path</span><span class="p">,</span>
    <span class="n">expiration_date</span><span class="p">,</span>
    <span class="n">workflow_id</span><span class="p">,</span>
    <span class="n">client_paths</span><span class="p">,</span>
    <span class="n">transfer_type</span><span class="p">,</span>
    <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">transfer_information</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>
    <span class="n">progression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_progression</span><span class="p">(</span><span class="n">status</span><span class="p">,</span>
                                             <span class="n">transfer_type</span><span class="p">,</span>
                                             <span class="n">client_path</span><span class="p">,</span>
                                             <span class="n">client_paths</span><span class="p">,</span>
                                             <span class="n">transfer_id</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">progression</span><span class="p">)</span>


  <span class="c">########## WORKFLOW CONTROL ############################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.restart_workflow"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.restart_workflow">[docs]</a>  <span class="k">def</span> <span class="nf">restart_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span> <span class="n">queue</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Restarts the jobs of the workflow which failed. The jobs will be submitted</span>
<span class="sd">    again.</span>
<span class="sd">    The workflow status has to be constants.WORKFLOW_DONE.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * queue *string*</span>
<span class="sd">        Optional name of the queue where to submit jobs. If it is not specified</span>
<span class="sd">        the jobs will be submitted to the default queue.</span>

<span class="sd">    * returns: *boolean*</span>
<span class="sd">        True if some jobs were restarted.</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">MPI_SCHEDULER</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SomaWorkflowError</span><span class="p">(</span><span class="s">&quot;The MPI scheduler is configured for this resource. &quot;</span>
                              <span class="s">&quot;Use soma.workflow.MPI_workflow_runner to restart a workflow using the MPI scheduler.&quot;</span><span class="p">)</span> 

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">restart_workflow</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span> <span class="n">queue</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.delete_workflow"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.delete_workflow">[docs]</a>  <span class="k">def</span> <span class="nf">delete_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Deletes the workflow and all its associated elements (FileTransfers and</span>
<span class="sd">    Jobs). The worklfow_id will become invalid and can not be used anymore.</span>
<span class="sd">    The workflow jobs which are running will be killed.</span>
<span class="sd">    If force is set to True: the call will block until the workflow is</span>
<span class="sd">    deleted. With force set to True, if the workflow can not be deleted properly</span>
<span class="sd">    it is deleted from Soma-workflow database. However, if some jobs are still</span>
<span class="sd">    running they are not be killed. In this case the return value is False.</span>

<span class="sd">    * workflow_id *workflow_identifier*</span>

<span class="sd">    * force *boolean*</span>

<span class="sd">    * returns: *boolean*</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#cProfile.runctx(&quot;self._engine_proxy.delete_workflow(workflow_id)&quot;, globals(), locals(), &quot;/home/soizic/profile/profile_delete_workflow&quot;)</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">delete_workflow</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.stop_workflow"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.stop_workflow">[docs]</a>  <span class="k">def</span> <span class="nf">stop_workflow</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Stops a workflow.</span>
<span class="sd">    The running jobs will be killed.</span>
<span class="sd">    The jobs in queues will be removed from queues.</span>
<span class="sd">    It will be possible to restart the workflow afterwards.</span>

<span class="sd">     * returns: *boolean*</span>

<span class="sd">      return True if the running jobs were killed and False</span>
<span class="sd">      if some jobs are possibly still running on the computing resource </span>
<span class="sd">      despite the workflow was stopped.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">engine_config_proxy</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">MPI_SCHEDULER</span><span class="p">:</span>
      <span class="k">raise</span> <span class="n">SomaWorkflowError</span><span class="p">(</span><span class="s">&quot;The MPI scheduler is configured for this resource. &quot;</span>
                              <span class="s">&quot;Kill the soma.workflow.MPI_workflow_runner job to stop the workflow.&quot;</span><span class="p">)</span> 


    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">stop_workflow</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WorkflowController.change_workflow_expiration_date"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.change_workflow_expiration_date">[docs]</a>  <span class="k">def</span> <span class="nf">change_workflow_expiration_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">,</span> <span class="n">new_expiration_date</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Sets a new expiration date for the workflow.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * new_expiration_date *datetime.datetime*</span>

<span class="sd">    * returns: *boolean*</span>
<span class="sd">        True if the expiration date was changed.</span>

<span class="sd">    Raises *UnknownObjectError* if the workflow_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">change_workflow_expiration_date</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span> <span class="n">new_expiration_date</span><span class="p">)</span>


  <span class="c">########## JOB CONTROL #################################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.wait_job"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.wait_job">[docs]</a>  <span class="k">def</span> <span class="nf">wait_job</span><span class="p">(</span> <span class="bp">self</span><span class="p">,</span> <span class="n">job_ids</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Waits for all the specified jobs to finish.</span>

<span class="sd">    * job_ids *sequence of job identifier*</span>
<span class="sd">        Jobs to wait for.</span>

<span class="sd">    * timeout *int*</span>
<span class="sd">        The call to wait_job exits before timeout seconds.</span>
<span class="sd">        A negative value means that the method will wait indefinetely.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">wait_job</span><span class="p">(</span><span class="n">job_ids</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
</div>
<div class="viewcode-block" id="WorkflowController.kill_job"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.kill_job">[docs]</a>  <span class="k">def</span> <span class="nf">kill_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span> <span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **deprecated since version 2.4:** Use stop_workflow instead.</span>

<span class="sd">    Kills a running job. The job will not be deleted from the system (the job</span>
<span class="sd">    identifier remains valid).</span>
<span class="sd">    Use the restart_job method to restart the job.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">print</span> <span class="s">&quot;The method kill_job is deprecated since version 2.4. Use stop_workflow instead.&quot;</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">kill_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.restart_job"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.restart_job">[docs]</a>  <span class="k">def</span> <span class="nf">restart_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **deprecated since version 2.4:** Use restart_workflow instead.</span>

<span class="sd">    Restarts a job which status is constants.FAILED or constants.WARNING.</span>

<span class="sd">    * job_id *job identifier*</span>
<span class="sd">    * returns: *boolean*</span>
<span class="sd">        True if the job was restarted.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">print</span> <span class="s">&quot;The method restart_job is deprecated since version 2.4. Use submit_workflow instead.&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">restart_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>

</div>
<div class="viewcode-block" id="WorkflowController.delete_job"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.delete_job">[docs]</a>  <span class="k">def</span> <span class="nf">delete_job</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job_id</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    **deprecated since version 2.4:** Use delete_workflow instead.</span>

<span class="sd">    Deletes a job which is not part of a workflow.</span>
<span class="sd">    The job_id will become invalid and can not be used anymore.</span>
<span class="sd">    The job is killed if it is running.</span>

<span class="sd">    Raises *UnknownObjectError* if the job_id is not valid</span>

<span class="sd">    * returns: *boolean*</span>
<span class="sd">      If force is True: return True if the running jobs were killed and False</span>
<span class="sd">      if some jobs are possibly still running on the computing resource despite</span>
<span class="sd">      the workflow doesn&#39;t exist.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">print</span> <span class="s">&quot;The method delete_job is deprecated since version 2.4. Use delete_workflow instead.&quot;</span>

    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">delete_job</span><span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>


  <span class="c">########## FILE TRANSFER CONTROL #######################################</span>
</div>
<div class="viewcode-block" id="WorkflowController.transfer_files"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.transfer_files">[docs]</a>  <span class="k">def</span> <span class="nf">transfer_files</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_ids</span><span class="p">,</span> <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">512</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transfer file(s) associated to the transfer_id.</span>
<span class="sd">    If the files are only located on the client side (that is the transfer</span>
<span class="sd">    status is constants.FILES_ON_CLIENT) the file(s) will be transfered from the</span>
<span class="sd">    client to the computing resource.</span>
<span class="sd">    If the files are located on the computing resource side (that is the</span>
<span class="sd">    transfer status is constants.FILES_ON_CR or</span>
<span class="sd">    constants.FILES_ON_CLIENT_AND_CR)</span>
<span class="sd">    the files will be transfered from the computing resource to the client.</span>

<span class="sd">    * transfer_id *FileTransfer identifier*</span>

<span class="sd">    * buffer_size *int*</span>
<span class="sd">        Depending on the transfer method, the files can be transfered piece by</span>
<span class="sd">        piece. The size of each piece can be tuned using the buffer_size</span>
<span class="sd">        argument.</span>

<span class="sd">    * returns: *boolean*</span>
<span class="sd">        The transfer was done. (TBI right error management)</span>

<span class="sd">    Raises *UnknownObjectError* if the transfer_id is not valid</span>
<span class="sd">    #Raises *TransferError*</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">transfer_ids</span><span class="p">)</span> <span class="ow">in</span> <span class="n">types</span><span class="o">.</span><span class="n">StringTypes</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">transfer_id</span> <span class="ow">in</span> <span class="n">transfer_ids</span><span class="p">:</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_file</span><span class="p">(</span><span class="n">transfer_ids</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>


</div>
<div class="viewcode-block" id="WorkflowController.delete_transfer"><a class="viewcode-back" href="../client_API.html#client.WorkflowController.delete_transfer">[docs]</a>  <span class="k">def</span> <span class="nf">delete_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Deletes the FileTransfer and the associated files and directories on the</span>
<span class="sd">    computing resource side. The transfer_id will become invalid and can not be</span>
<span class="sd">    used anymore. If some jobs reference the FileTransfer as an input or an</span>
<span class="sd">    output the FileTransfer will not be deleted immediately but as soon as these</span>
<span class="sd">    jobs will be deleted.</span>

<span class="sd">    Raises *UnknownObjectError* if the transfer_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">delete_transfer</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>


  <span class="c">########## PRIVATE #############################################</span>
</div>
  <span class="k">def</span> <span class="nf">_initialize_transfer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Initializes the transfer and returns the transfer action information.</span>

<span class="sd">    * transfer_id *FileTransfer identifier*</span>

<span class="sd">    * returns: *tuple*</span>
<span class="sd">        transfer_type</span>


<span class="sd">        * (file_size, md5_hash) in the case of a file transfer</span>
<span class="sd">        * (cumulated_size, dictionary relative path -&gt; (file_size, md5_hash)) in</span>
<span class="sd">          case of a directory transfer.</span>

<span class="sd">    Raises *UnknownObjectError* if the transfer_id is not valid</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
     <span class="n">client_path</span><span class="p">,</span>
     <span class="n">expiration_date</span><span class="p">,</span>
     <span class="n">workflow_id</span><span class="p">,</span>
     <span class="n">client_paths</span><span class="p">,</span>
     <span class="n">transfer_type</span><span class="p">,</span>
     <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">transfer_information</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">client_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">client_path</span><span class="p">):</span>
          <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_FILE_C_TO_CR</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                                 <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_type</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">transfer_type</span><span class="p">)</span>


        <span class="k">elif</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">client_path</span><span class="p">):</span>
          <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_DIR_C_TO_CR</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                                 <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_type</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">TR_DIR_C_TO_CR</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: The file or directory </span><span class="si">%s</span><span class="s"> doesn&#39;t exist &quot;</span>
                <span class="s">&quot;on the client machine.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">client_path</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span> <span class="c">#client_paths</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: The file or directory </span><span class="si">%s</span><span class="s"> doesn&#39;t exist &quot;</span>
                  <span class="s">&quot;on the client machine.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">path</span><span class="p">))</span>
        <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_C_TO_CR</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                             <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_type</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                           <span class="n">transfer_type</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">transfer_type</span>

    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CR</span> <span class="ow">or</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">:</span>
      <span class="c">#transfer_type = self._engine_proxy.init_transfer_from_cr(transfer_id,</span>
                                               <span class="c">#client_path,</span>
                                               <span class="c">#expiration_date,</span>
                                               <span class="c">#workflow_id,</span>
                                               <span class="c">#client_paths,</span>
                                               <span class="c">#status)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">client_paths</span><span class="p">:</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">is_file</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">):</span>
          <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_FILE_CR_TO_C</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">):</span>
          <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_DIR_CR_TO_C</span>
        <span class="k">else</span><span class="p">:</span>
          <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: The file or directory </span><span class="si">%s</span><span class="s"> doesn&#39;t exist &quot;</span>
                <span class="s">&quot;on the computing resource side.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">))</span>
      <span class="k">else</span><span class="p">:</span> <span class="c">#client_paths</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
          <span class="n">r_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
          <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">is_file</span><span class="p">(</span><span class="n">r_path</span><span class="p">)</span> <span class="ow">and</span> \
             <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">is_dir</span><span class="p">(</span><span class="n">r_path</span><span class="p">):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;WARNING: The file or directory </span><span class="si">%s</span><span class="s"> doesn&#39;t exist &quot;</span>
                  <span class="s">&quot;on the computing resource side.&quot;</span> <span class="o">%</span><span class="p">(</span><span class="n">r_path</span><span class="p">))</span>
        <span class="n">transfer_type</span> <span class="o">=</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_CR_TO_C</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                        <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CR_TO_CLIENT</span><span class="p">)</span>
      <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_type</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                           <span class="n">transfer_type</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">transfer_type</span>


  <span class="k">def</span> <span class="nf">_transfer_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">transfer_id</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">):</span>

    <span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
     <span class="n">client_path</span><span class="p">,</span>
     <span class="n">expiration_date</span><span class="p">,</span>
     <span class="n">workflow_id</span><span class="p">,</span>
     <span class="n">client_paths</span><span class="p">,</span>
     <span class="n">transfer_type</span><span class="p">,</span>
     <span class="n">status</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">transfer_information</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT</span> <span class="ow">or</span> \
       <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">:</span>
      <span class="c"># transfer from client to computing resource</span>
      <span class="c">#overwrite = False</span>
      <span class="c">#if not transfer_type or \</span>
         <span class="c">#transfer_type == constants.TR_FILE_CR_TO_C or \</span>
         <span class="c">#transfer_type == constants.TR_DIR_CR_TO_C or \</span>
         <span class="c">#transfer_type == constants.TR_MFF_CR_TO_C:</span>
        <span class="c">## transfer reset</span>
        <span class="c">#overwrite = True</span>
      <span class="n">transfer_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_transfer</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>

      <span class="n">remote_path</span> <span class="o">=</span> <span class="n">transfer_id</span>

      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_FILE_C_TO_CR</span> <span class="ow">or</span> \
         <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_DIR_C_TO_CR</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span><span class="o">.</span><span class="n">transfer_to_remote</span><span class="p">(</span><span class="n">client_path</span><span class="p">,</span>
                                         <span class="n">remote_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">signalTransferEnded</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_C_TO_CR</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
          <span class="n">r_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span><span class="o">.</span><span class="n">transfer_to_remote</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                            <span class="n">r_path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">signalTransferEnded</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CR</span> <span class="ow">or</span> \
       <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CR_TO_CLIENT</span> <span class="ow">or</span> \
       <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">:</span>
      <span class="c"># transfer from computing resource to client</span>
      <span class="c">#overwrite = False</span>
      <span class="c">#if not transfer_type or \</span>
         <span class="c">#transfer_type == constants.TR_FILE_C_TO_CR or \</span>
         <span class="c">#transfer_type == constants.TR_DIR_C_TO_CR or \</span>
         <span class="c">#transfer_type == constants.TR_MFF_C_TO_CR :</span>
        <span class="c">## TBI remove existing files</span>
        <span class="c">#overwrite = True</span>
      <span class="n">transfer_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_initialize_transfer</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">)</span>


      <span class="n">remote_path</span> <span class="o">=</span> <span class="n">transfer_id</span>
      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_FILE_CR_TO_C</span> <span class="ow">or</span> \
         <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_DIR_CR_TO_C</span><span class="p">:</span>
        <span class="c"># file case</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span><span class="o">.</span><span class="n">transfer_from_remote</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span>
                                            <span class="n">client_path</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">signalTransferEnded</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_CR_TO_C</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
          <span class="n">r_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">remote_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
          <span class="bp">self</span><span class="o">.</span><span class="n">_transfer</span><span class="o">.</span><span class="n">transfer_from_remote</span><span class="p">(</span><span class="n">r_path</span><span class="p">,</span>
                                              <span class="n">path</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">set_transfer_status</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span>
                                               <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT_AND_CR</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_engine_proxy</span><span class="o">.</span><span class="n">signalTransferEnded</span><span class="p">(</span><span class="n">transfer_id</span><span class="p">,</span> <span class="n">workflow_id</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="k">return</span> <span class="bp">False</span>


  <span class="k">def</span> <span class="nf">_transfer_progression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">status</span><span class="p">,</span>
                            <span class="n">transfer_type</span><span class="p">,</span>
                            <span class="n">client_path</span><span class="p">,</span>
                            <span class="n">client_paths</span><span class="p">,</span>
                            <span class="n">engine_path</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_C_TO_CR</span><span class="p">:</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data_transfered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
          <span class="n">r_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engine_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
          <span class="p">(</span><span class="n">ds</span><span class="p">,</span>
          <span class="n">dt</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_monitoring</span><span class="o">.</span><span class="n">transfer_to_remote_progression</span><span class="p">(</span><span class="n">path</span><span class="p">,</span>
                                                                <span class="n">r_path</span><span class="p">)</span>
          <span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">+</span> <span class="n">ds</span>
          <span class="n">data_transfered</span> <span class="o">=</span> <span class="n">data_transfered</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="n">progression</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="n">data_transfered</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">progression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_monitoring</span><span class="o">.</span><span class="n">transfer_to_remote_progression</span><span class="p">(</span>
                                                                <span class="n">client_path</span><span class="p">,</span>
                                                                <span class="n">engine_path</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CR_TO_CLIENT</span><span class="p">:</span>
      <span class="k">if</span> <span class="n">transfer_type</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TR_MFF_CR_TO_C</span><span class="p">:</span>
        <span class="n">data_size</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">data_transfered</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">client_paths</span><span class="p">:</span>
          <span class="n">relative_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
          <span class="n">r_path</span> <span class="o">=</span> <span class="n">posixpath</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">engine_path</span><span class="p">,</span> <span class="n">relative_path</span><span class="p">)</span>
          <span class="p">(</span><span class="n">ds</span><span class="p">,</span>
          <span class="n">dt</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_monitoring</span><span class="o">.</span><span class="n">transfer_from_remote_progression</span><span class="p">(</span><span class="n">r_path</span><span class="p">,</span>
                                                                         <span class="n">path</span><span class="p">)</span>
          <span class="n">data_size</span> <span class="o">=</span> <span class="n">data_size</span> <span class="o">+</span> <span class="n">ds</span>
          <span class="n">data_transfered</span> <span class="o">=</span> <span class="n">data_transfered</span> <span class="o">+</span> <span class="n">dt</span>
        <span class="n">progression</span> <span class="o">=</span> <span class="p">(</span><span class="n">data_size</span><span class="p">,</span> <span class="n">data_transfered</span><span class="p">)</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">progression</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transfer_monitoring</span><span class="o">.</span><span class="n">transfer_from_remote_progression</span><span class="p">(</span><span class="n">engine_path</span><span class="p">,</span>
                                                                  <span class="n">client_path</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="n">progression</span> <span class="o">=</span> <span class="p">(</span><span class="mi">100</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">progression</span>

</div>
<span class="k">def</span> <span class="nf">_embedded_engine_and_server</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">local_scheduler_config</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
  <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">  Creates the workflow engine and workflow database server in the client</span>
<span class="sd">  process.</span>
<span class="sd">  The client process can not finish before the workflows and jobs are done.</span>
<span class="sd">  Using serveral client process simultaneously (thus several database server</span>
<span class="sd">  with the same database file) can cause error (notably database locked problems)</span>

<span class="sd">  * config: *soma.workflow.configuration.Configuration*</span>

<span class="sd">  * returns: *WorkflowEngine*</span>
<span class="sd">  &#39;&#39;&#39;</span>
  <span class="kn">import</span> <span class="nn">logging</span>

  <span class="kn">from</span> <span class="nn">soma.workflow.engine</span> <span class="kn">import</span> <span class="n">WorkflowEngine</span><span class="p">,</span> <span class="n">ConfiguredWorkflowEngine</span>
  <span class="kn">from</span> <span class="nn">soma.workflow.database_server</span> <span class="kn">import</span> <span class="n">WorkflowDatabaseServer</span>

  <span class="p">(</span><span class="n">engine_log_dir</span><span class="p">,</span>
  <span class="n">engine_log_format</span><span class="p">,</span>
  <span class="n">engine_log_level</span><span class="p">)</span> <span class="o">=</span> <span class="n">config</span><span class="o">.</span><span class="n">get_engine_log_info</span><span class="p">()</span>
  <span class="k">if</span> <span class="n">engine_log_dir</span><span class="p">:</span>
    <span class="n">logfilepath</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">engine_log_dir</span><span class="p">),</span> <span class="s">&quot;log_light_mode&quot;</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span>
        <span class="n">filename</span><span class="o">=</span><span class="n">logfilepath</span><span class="p">,</span>
        <span class="n">format</span><span class="o">=</span><span class="n">engine_log_format</span><span class="p">,</span>
        <span class="n">level</span><span class="o">=</span><span class="nb">eval</span><span class="p">(</span><span class="s">&quot;logging.&quot;</span> <span class="o">+</span> <span class="n">engine_log_level</span><span class="p">))</span>
    <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s">&#39;engine&#39;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;****************************************************&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s">&quot;****************************************************&quot;</span><span class="p">)</span>

  <span class="c"># database server</span>
  <span class="n">database_server</span> <span class="o">=</span> <span class="n">WorkflowDatabaseServer</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_database_file</span><span class="p">(),</span>
                                           <span class="n">config</span><span class="o">.</span><span class="n">get_transfered_file_dir</span><span class="p">())</span>

  <span class="k">if</span> <span class="n">config</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">DRMAA_SCHEDULER</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">soma.workflow.scheduler</span> <span class="kn">import</span> <span class="n">Drmaa</span>
    <span class="c">#print &quot;scheduler type: drmaa&quot;</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">Drmaa</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">get_drmaa_implementation</span><span class="p">(),</span>
                      <span class="n">config</span><span class="o">.</span><span class="n">get_parallel_job_config</span><span class="p">(),</span>
                      <span class="n">configured_native_spec</span><span class="o">=</span><span class="n">config</span><span class="o">.</span><span class="n">get_native_specification</span><span class="p">())</span>

  <span class="k">elif</span> <span class="n">config</span><span class="o">.</span><span class="n">get_scheduler_type</span><span class="p">()</span> <span class="o">==</span> <span class="n">configuration</span><span class="o">.</span><span class="n">LOCAL_SCHEDULER</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">soma.workflow.scheduler</span> <span class="kn">import</span> <span class="n">ConfiguredLocalScheduler</span>
    <span class="k">if</span> <span class="n">local_scheduler_config</span> <span class="o">==</span> <span class="bp">None</span><span class="p">:</span>
      <span class="n">local_scheduler_config</span> <span class="o">=</span> <span class="n">LocalSchedulerCfg</span><span class="p">()</span>
    <span class="c">#print &quot;scheduler type: basic, number of cpu: &quot; + repr(local_scheduler_config.get_proc_nb())</span>
    <span class="n">scheduler</span> <span class="o">=</span> <span class="n">ConfiguredLocalScheduler</span><span class="p">(</span><span class="n">local_scheduler_config</span><span class="p">)</span>

  <span class="n">workflow_engine</span> <span class="o">=</span> <span class="n">ConfiguredWorkflowEngine</span><span class="p">(</span><span class="n">database_server</span><span class="p">,</span>
                                             <span class="n">scheduler</span><span class="p">,</span> 
                                             <span class="n">config</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">workflow_engine</span>


<span class="k">class</span> <span class="nc">Helper</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

  <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">pass</span>


  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.list_failed_jobs"><a class="viewcode-back" href="../client_API.html#client.Helper.list_failed_jobs">[docs]</a>  <span class="k">def</span> <span class="nf">list_failed_jobs</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span>
                      <span class="n">wf_ctrl</span><span class="p">,</span>
                      <span class="n">include_aborted_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                      <span class="n">include_user_killed_jobs</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    To spot the problematic jobs in a workflow.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>
<span class="sd">    </span>
<span class="sd">    * include_aborted_jobs *boolean*</span>
<span class="sd">      Include the jobs which exit status is constants.EXIT_ABORTED</span>

<span class="sd">    * include_user_killed_jobs *boolean*</span>
<span class="sd">      Include the jobs which exit status is constants.USER_KILLED</span>

<span class="sd">    * returns: *list of job identifier*</span>
<span class="sd">      Return the list of id of job which status is constants.FAILED</span>
<span class="sd">      or which exit value is not 0.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="p">(</span><span class="n">jobs_info</span><span class="p">,</span> 
    <span class="n">transfers_info</span><span class="p">,</span> 
    <span class="n">workflow_status</span><span class="p">,</span> 
    <span class="n">workflow_queue</span><span class="p">)</span> <span class="o">=</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflow_elements_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
    <span class="n">failed_job_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">job_id</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">exit_info</span><span class="p">,</span> <span class="n">dates</span><span class="p">)</span> <span class="ow">in</span> <span class="n">jobs_info</span><span class="p">:</span>
      <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">DONE</span> <span class="ow">and</span> <span class="n">exit_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> \
        <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FAILED</span> <span class="ow">and</span> \
        <span class="p">(</span><span class="n">include_aborted_jobs</span> <span class="ow">or</span> <span class="n">exit_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">constants</span><span class="o">.</span><span class="n">EXIT_ABORTED</span><span class="p">)</span> <span class="ow">and</span> \
        <span class="p">(</span><span class="n">include_user_killed_jobs</span> <span class="ow">or</span> <span class="n">exit_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">constants</span><span class="o">.</span><span class="n">USER_KILLED</span><span class="p">)):</span>
        <span class="n">failed_job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_id</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">failed_job_ids</span>
</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.delete_all_workflows"><a class="viewcode-back" href="../client_API.html#client.Helper.delete_all_workflows">[docs]</a>  <span class="k">def</span> <span class="nf">delete_all_workflows</span><span class="p">(</span><span class="n">wf_ctrl</span><span class="p">,</span> <span class="n">force</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Delete all the workflows.</span>
<span class="sd">    If force is set to True: the call will block until the workflows are</span>
<span class="sd">    deleted. With force set to True, if a workflow can not be deleted properly</span>
<span class="sd">    it is deleted from Soma-workflow database. However, if some jobs are still</span>
<span class="sd">    running they will not be killed. In this case the return value is False.</span>
<span class="sd">    </span>
<span class="sd">    * wf_ctrl *client.WorkflowController*</span>

<span class="sd">    * force *boolean*</span>

<span class="sd">    * returns: *boolean*</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">deleted_properly</span> <span class="o">=</span> <span class="bp">True</span>
    <span class="k">while</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflows</span><span class="p">():</span>
      <span class="n">wf_id</span> <span class="o">=</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflows</span><span class="p">()</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">deleted_properly</span> <span class="o">=</span> <span class="n">deleted_properly</span> <span class="ow">and</span>  <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">delete_workflow</span><span class="p">(</span><span class="n">wf_id</span><span class="p">,</span> <span class="n">force</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">deleted_properly</span>

</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.wait_workflow"><a class="viewcode-back" href="../client_API.html#client.Helper.wait_workflow">[docs]</a>  <span class="k">def</span> <span class="nf">wait_workflow</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span>
                    <span class="n">wf_ctrl</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Waits for workflow execution to end.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * wf_ctrl *client.WorkflowController*</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">element_status</span> <span class="o">=</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflow_elements_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>
    <span class="n">job_ids</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">job_info</span> <span class="ow">in</span> <span class="n">element_status</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
      <span class="n">job_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">job_info</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>


    <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">wait_job</span><span class="p">(</span><span class="n">job_ids</span><span class="p">)</span>


</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.transfer_input_files"><a class="viewcode-back" href="../client_API.html#client.Helper.transfer_input_files">[docs]</a>  <span class="k">def</span> <span class="nf">transfer_input_files</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span>
                           <span class="n">wf_ctrl</span><span class="p">,</span>
                           <span class="n">buffer_size</span> <span class="o">=</span> <span class="mi">512</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transfers all the input files of a workflow.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * wf_ctrl *client.WorkflowController*</span>

<span class="sd">    * buffer_size *int*</span>
<span class="sd">        Depending on the transfer method, the files can be transfered piece by</span>
<span class="sd">        piece. The size of each piece can be tuned using the buffer_size</span>
<span class="sd">        argument.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">transfer_info</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">wf_elements_status</span> <span class="o">=</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflow_elements_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>

    <span class="n">to_transfer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">transfer_info</span> <span class="ow">in</span> <span class="n">wf_elements_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CLIENT</span><span class="p">:</span>
        <span class="n">engine_path</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">to_transfer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_path</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CLIENT_TO_CR</span><span class="p">:</span>
        <span class="n">engine_path</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">to_transfer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_path</span><span class="p">)</span>

    <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">transfer_files</span><span class="p">(</span><span class="n">to_transfer</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>


</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.transfer_output_files"><a class="viewcode-back" href="../client_API.html#client.Helper.transfer_output_files">[docs]</a>  <span class="k">def</span> <span class="nf">transfer_output_files</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">,</span>
                            <span class="n">wf_ctrl</span><span class="p">,</span>
                            <span class="n">buffer_size</span><span class="o">=</span><span class="mi">512</span><span class="o">**</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Transfers all the output files of a workflow which are ready to transfer.</span>

<span class="sd">    * workflow_id *workflow identifier*</span>

<span class="sd">    * wf_ctrl *client.WorkflowController*</span>

<span class="sd">    * buffer_size *int*</span>
<span class="sd">        Depending on the transfer method, the files can be transfered piece by</span>
<span class="sd">        piece. The size of each piece can be tuned using the buffer_size</span>
<span class="sd">        argument.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">transfer_info</span> <span class="o">=</span> <span class="bp">None</span>
    <span class="n">wf_elements_status</span> <span class="o">=</span> <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">workflow_elements_status</span><span class="p">(</span><span class="n">workflow_id</span><span class="p">)</span>

    <span class="n">to_transfer</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">transfer_info</span> <span class="ow">in</span> <span class="n">wf_elements_status</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
      <span class="n">status</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">FILES_ON_CR</span><span class="p">:</span>
        <span class="n">engine_path</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">to_transfer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_path</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">status</span> <span class="o">==</span> <span class="n">constants</span><span class="o">.</span><span class="n">TRANSFERING_FROM_CR_TO_CLIENT</span><span class="p">:</span>
        <span class="n">engine_path</span> <span class="o">=</span> <span class="n">transfer_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">to_transfer</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">engine_path</span><span class="p">)</span>

    <span class="n">wf_ctrl</span><span class="o">.</span><span class="n">transfer_files</span><span class="p">(</span><span class="n">to_transfer</span><span class="p">,</span> <span class="n">buffer_size</span><span class="p">)</span>


</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.serialize"><a class="viewcode-back" href="../client_API.html#client.Helper.serialize">[docs]</a>  <span class="k">def</span> <span class="nf">serialize</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">workflow</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Saves a workflow to a file.</span>
<span class="sd">    Uses JSON format if Python &gt;= 2.6, Python pickle otherwise.</span>

<span class="sd">    * file_path *String*</span>

<span class="sd">    * workflow *client.Workflow*</span>

<span class="sd">    Raises *SerializationError*</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">workflow_dict</span> <span class="o">=</span> <span class="n">workflow</span><span class="o">.</span><span class="n">to_dict</span><span class="p">()</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">workflow_dict</span><span class="p">,</span> <span class="nb">file</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="nb">file</span><span class="p">)</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
  

</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.unserialize"><a class="viewcode-back" href="../client_API.html#client.Helper.unserialize">[docs]</a>  <span class="k">def</span> <span class="nf">unserialize</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Loads a workflow from a file.</span>
<span class="sd">    Opens JSON format or pickle if Python &gt;= 2.6, only Python pickle otherwise </span>
<span class="sd">    (see the method: Helper.convert_wf_file_for_p2_5).</span>

<span class="sd">    * file_path *String*</span>

<span class="sd">    * returns: *client.Workflow*</span>

<span class="sd">    Raises *SerializationError*</span>
<span class="sd">    &#39;&#39;&#39;</span>
   
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

      <span class="n">workflow</span> <span class="o">=</span> <span class="bp">None</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="n">dict_from_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">ValueError</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">pass</span>
      <span class="k">else</span><span class="p">:</span>
        <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_from_json</span><span class="p">)</span>

      <span class="k">if</span> <span class="ow">not</span> <span class="n">workflow</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
          <span class="n">workflow</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
          <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>

      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
      
    <span class="k">else</span><span class="p">:</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
      <span class="k">try</span><span class="p">:</span> 
        <span class="n">workflow</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;Error </span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s"> </span><span class="se">\n\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;The workflow file may have been created &quot;</span>
                                 <span class="s">&quot;using Python &gt;= 2.6 using the JSON format.</span><span class="se">\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;Use the converter: </span><span class="se">\n</span><span class="s">&quot;</span>
                                 <span class="s">&quot;soma.workflow.client.Helper.convert_wf_file_for_p2_5 &quot;</span>
                                 <span class="s">&quot; &quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="nb">file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
 


    <span class="c"># compatibility with version 2.2 and previous</span>
    <span class="k">for</span> <span class="n">job</span> <span class="ow">in</span> <span class="n">workflow</span><span class="o">.</span><span class="n">jobs</span><span class="p">:</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">job</span><span class="p">,</span> <span class="s">&quot;native_specification&quot;</span><span class="p">):</span>
        <span class="n">job</span><span class="o">.</span><span class="n">native_specification</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="k">return</span> <span class="n">workflow</span>
</div>
  <span class="nd">@staticmethod</span>
<div class="viewcode-block" id="Helper.convert_wf_file_for_p2_5"><a class="viewcode-back" href="../client_API.html#client.Helper.convert_wf_file_for_p2_5">[docs]</a>  <span class="k">def</span> <span class="nf">convert_wf_file_for_p2_5</span><span class="p">(</span><span class="n">origin_file_path</span><span class="p">,</span> <span class="n">target_file_path</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    This method requires Python &gt;= 2.6.</span>
<span class="sd">    It converts a workflow file created using Python &gt;= 2.6 to workflow file</span>
<span class="sd">    usable in Python 2.5.</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">):</span>
      <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s">&quot;convert_wf_file_for_p2_5 requires Python &gt;= 2.6.&quot;</span><span class="p">)</span>
  
    <span class="k">try</span><span class="p">:</span>
      <span class="n">o_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">origin_file_path</span><span class="p">,</span> <span class="s">&quot;r&quot;</span><span class="p">)</span>
      <span class="n">dict_from_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">o_file</span><span class="p">)</span>
      <span class="n">workflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">dict_from_json</span><span class="p">)</span>  
      <span class="n">o_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
      <span class="n">t_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">target_file_path</span><span class="p">,</span> <span class="s">&quot;w&quot;</span><span class="p">)</span>
      <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">workflow</span><span class="p">,</span> <span class="n">t_file</span><span class="p">)</span>
      <span class="n">t_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>      
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
      <span class="n">SerializationError</span><span class="p">(</span><span class="s">&quot;</span><span class="si">%s</span><span class="s">: </span><span class="si">%s</span><span class="s">&quot;</span> <span class="o">%</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">),</span> <span class="n">e</span><span class="p">))</span>
</div>
  <span class="nd">@staticmethod</span>
  <span class="k">def</span> <span class="nf">cpu_count</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Detects the number of CPUs on a system.</span>
<span class="sd">    ==&gt; Python &gt;= 2.6: multiprocessing.cpu_count</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span><span class="p">[:</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
      <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span> <span class="nn">multiprocessing</span>
        <span class="k">return</span> <span class="n">multiprocessing</span><span class="o">.</span><span class="n">cpu_count</span><span class="p">()</span>
      <span class="k">except</span><span class="p">:</span> <span class="c"># sometimes happens on MacOS... ?</span>
        <span class="k">print</span> <span class="o">&gt;&gt;</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span> \
            <span class="s">&#39;Warning: CPU count detection failed. Using default (2)&#39;</span>
        <span class="k">return</span> <span class="mi">2</span>
    <span class="c"># Linux, Unix and MacOS:</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">os</span><span class="p">,</span> <span class="s">&quot;sysconf&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf_names</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;SC_NPROCESSORS_ONLN&quot;</span><span class="p">):</span>
            <span class="c"># Linux &amp; Unix:</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">sysconf</span><span class="p">(</span><span class="s">&quot;SC_NPROCESSORS_ONLN&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ncpus</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">and</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ncpus</span>
        <span class="k">else</span><span class="p">:</span> <span class="c"># OSX:</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">([</span><span class="s">&quot;sysctl&quot;</span><span class="p">,</span> <span class="s">&quot;-n&quot;</span><span class="p">,</span> <span class="s">&quot;hw.ncpu&quot;</span><span class="p">],</span>
                <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="c"># Windows:</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">has_key</span><span class="p">(</span><span class="s">&quot;NUMBER_OF_PROCESSORS&quot;</span><span class="p">):</span>
            <span class="n">ncpus</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s">&quot;NUMBER_OF_PROCESSORS&quot;</span><span class="p">]);</span>
            <span class="k">if</span> <span class="n">ncpus</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">ncpus</span>
    <span class="k">return</span> <span class="mi">1</span> <span class="c"># Default</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
            <p class="logo"><a href="../index.html">
              <img class="logo" src="../static/logo_white_small.png" alt="Logo"/>
            </a></p>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li><a href="../index.html">soma-workflow developement version documentation</a> &raquo;</li>
          <li><a href="index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2011 CEA, Neurospin, France, CATI, France.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>